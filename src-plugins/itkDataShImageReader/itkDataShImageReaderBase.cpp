// /////////////////////////////////////////////////////////////////
// Generated by dtkPluginGenerator
// /////////////////////////////////////////////////////////////////

#include "itkDataShImageReaderBase.h"

#include <dtkCore/dtkAbstractData.h>
#include <dtkCore/dtkAbstractDataFactory.h>

#include <itkImageFileReader.h>
#include <itkObjectFactoryBase.h>
#include <itkImageRegionConstIteratorWithIndex.h>
#include <itkImageRegionIteratorWithIndex.h>

// /////////////////////////////////////////////////////////////////
// itkDataShImageReader
// /////////////////////////////////////////////////////////////////

itkDataShImageReaderBase::itkDataShImageReaderBase(void) : dtkAbstractDataReader()
{
    this->io = 0;
}

itkDataShImageReaderBase::~itkDataShImageReaderBase(void)
{
}

QStringList itkDataShImageReaderBase::handled(void) const
{
    return QStringList() << "itkDataShImageDouble3"
                         << "itkDataShImageFloat3";
}

QStringList itkDataShImageReaderBase::s_handled(void)
{
    return QStringList() << "itkDataShImageDouble3"
                         << "itkDataShImageFloat3";
}

bool itkDataShImageReaderBase::canRead (const QStringList &paths)
{
    if (paths.count())
        return this->canRead (paths[0]);
    return false;
}

bool itkDataShImageReaderBase::canRead (const QString &path)
{
    if (!this->io.IsNull()) {
        if (!this->io->CanReadFile ( path.toAscii().constData() ))
            return false;

        this->io->SetFileName (path.toAscii().constData());
        try {
            this->io->ReadImageInformation();
        }
        catch (itk::ExceptionObject &e) {
            qDebug() << e.GetDescription();
            return false;
        }
        const unsigned int compo = this->io->GetNumberOfComponents();
        //JGG qDebug() << "number of components sh image" << compo;
        if (this->io->GetNumberOfComponents/*PerPixel*/() != 15 && this->io->GetNumberOfComponents/*PerPixel*/() != 28)
            return false;

        return true;
    }
    return false;
}

bool itkDataShImageReaderBase::readInformation (const QStringList &paths)
{
    if (paths.count())
        return this->readInformation (paths[0]);

    return false;
}

bool itkDataShImageReaderBase::readInformation (const QString &path)
{
    if (this->io.IsNull())
        return false;
    
    this->io->SetFileName ( path.toAscii().constData() );
    try {
        this->io->ReadImageInformation();
    }
    catch (itk::ExceptionObject &e) {
        qDebug() << e.GetDescription();
        return false;
    }
    
    dtkAbstractData* dtkdata = this->data();

    if (!dtkdata) {

        switch (this->io->GetComponentType()) {
        //            qDebug() << this->io->GetPixelTypeAsString() << this->io->GetComponentTypeAsString();

        case itk::ImageIOBase::FLOAT:
            dtkdata = dtkAbstractDataFactory::instance()->create ("itkDataShImageFloat3");
            if (dtkdata)
                this->setData ( dtkdata );
            break;

	    case itk::ImageIOBase::DOUBLE:
			dtkdata = dtkAbstractDataFactory::instance()->create ("itkDataShImageDouble3");
			if (dtkdata)
				this->setData ( dtkdata );
			break;

	    default:
	        qDebug() << "Unsupported component type";
			return false ;
		}
    }

    if (dtkdata) {
        dtkdata->addMetaData ("FilePath", QStringList() << path);
    }
    return true;
}

bool itkDataShImageReaderBase::read (const QStringList &paths)
{
    if (paths.count())
        return this->read (paths[0]);
    return false;
}

bool itkDataShImageReaderBase::read (const QString &path)
{
    if (this->io.IsNull())
        return false;
	
    this->readInformation ( path );
	
    qDebug() << "Read with: " << this->description();

    if (dtkAbstractData *dtkdata = this->data() ) {

        if (dtkdata->identifier()=="itkDataShImageDouble3") {
            typedef itk::VectorImage<double, 3> ShImageType;
            typedef ShImageType::PixelType    ShType;

            typedef itk::ImageFileReader<ShImageType> ReaderType;

            ShImageType::Pointer image = 0;

            ReaderType::Pointer reader = ReaderType::New();
            reader->SetImageIO (this->io);
            reader->SetFileName ( path.toAscii().constData() );
            try {
                reader->Update();
            }
            catch (itk::ExceptionObject &e) {
                qDebug() << e.GetDescription();
                return false;
            }
            image = reader->GetOutput();
            dtkdata->setData (image);
        }
        else if (dtkdata->identifier()=="itkDataShImageFloat3") {
            typedef itk::VectorImage<float, 3> ShImageType;
            typedef ShImageType::PixelType    ShType;

            typedef itk::ImageFileReader<ShImageType> ReaderType;

            ShImageType::Pointer image = 0;

            ReaderType::Pointer reader = ReaderType::New();
            reader->SetImageIO (this->io);
            reader->SetFileName ( path.toAscii().constData() );
            try {
                reader->Update();
            }
            catch (itk::ExceptionObject &e) {
                qDebug() << e.GetDescription();
                return false;
            }
            image = reader->GetOutput();
            dtkdata->setData (image);

        }
        else {
            qDebug() << "Unsupported data type";
            return false;
        }
    }
    else {
        qDebug() << "No data set or could not create one";
        return false;
    }

    return true;
    
}

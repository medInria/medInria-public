#! /bin/bash

\rm -fr @CMAKE_INSTALL_PREFIX@/PackageRootDir
mkdir -p @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/{Frameworks,PlugIns}
mkdir -p @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/Frameworks/DCMTK
mkdir -p @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/Frameworks/Dcm

cd @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents

for i in $( otool -L @CMAKE_BINARY_DIR@/plugins/*.dylib 2> /dev/null \
| sort -u | grep -i -E '@medInria_DIR@|@dtk_DIR@|ttk|itk|vtk' | cut -d " " -f 1 ); do
	cp -np $i Frameworks/ 2> /dev/null;
done

for i in $( otool -L Frameworks/* 2> /dev/null \
| sort -u | grep -i -E '@medInria_DIR@|@dtk_DIR@|ttk|itk|vtk' | cut -d " " -f 1 ); do
	cp -np $i Frameworks 2> /dev/null;
done

# copy plugins in PlugIns directory

for i in @CMAKE_BINARY_DIR@/plugins/*.dylib; do
	cp -p $i PlugIns
done

for i in $(ls PlugIns | grep -E 'dylib' ); do
		#update library id
		install_name_tool -id @executable_path/../PlugIns/$i PlugIns/$i

	# ITK, VTK stuff
	for libname in `otool -L PlugIns/$i | sed "1d" | grep -i -E '@medInria_DIR@|@dtk_DIR@|ttk|itk|vtk' | cut -d " " -f 1`
	do
		install_name_tool -change $libname @executable_path/../Frameworks/`basename $libname` PlugIns/$i
	done

	for j in $( otool -L PlugIns/$i | sed "1d" | grep -E .framework | grep -i -E 'Qt|phonon' | cut -d " " -f 1 ); do
		#Depending on Qt SDK, paths may be relative or not
		#tmpVal=`echo $j | rev | cut -d "/" -f 1-4 | rev`
		if [ "`echo $j | grep executable_path`" == "" ]; then
			install_name_tool -change $j @executable_path/../Frameworks/$j PlugIns/$i
		fi
    done
    
    for libname in `otool -L PlugIns/$i | sed "1d" | grep @DCMTK_DIR@ | cut -d " " -f 1`
    do
    	baselibname=`basename $libname`
    	if [ ! -e Frameworks/DCMTK/$baselibname ]; then
			cp $libname Frameworks/DCMTK/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/DCMTK/$baselibname PlugIns/$i
	done
done

for f in PlugIns/libqtdcm*.dylib
do
	for libname in `otool -L $f | sed "1d" | grep @QTDCM_DIR@ | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		cp $libname Frameworks/Dcm/
		install_name_tool -change $libname @executable_path/../Frameworks/Dcm/$baselibname $f
	done

    for libname in `otool -L $f | sed "1d" | grep @DCMTK_DIR@ | cut -d " " -f 1`
    do
    	baselibname=`basename $libname`
    	if [ ! -e Frameworks/DCMTK/$baselibname ]; then
			cp $libname Frameworks/DCMTK/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/DCMTK/$baselibname $f
	done
done

for f in Frameworks/Dcm/*.dylib
do
	install_name_tool -id @executable_path/../$f $f

	# ITK stuff (already installed)
	for libname in `otool -L $f | sed "1d" | grep -i -E 'itk' | cut -d " " -f 1`
	do
		if [ ! -e Frameworks/`basename $libname` ]; then
			cp $libname Frameworks
		fi

		install_name_tool -change $libname @executable_path/../Frameworks/`basename $libname` $f
	done
	
	#Qt stuff (should hopefully be there already)
	for j in $( otool -L $f | sed "1d" | grep -E .framework | grep -i -E 'Qt|phonon' | cut -d " " -f 1 ); do
		#Depending on Qt SDK, paths may be relative or not
		tmpVal=`echo $j | rev | cut -d "/" -f 1-4 | rev`
		if [ "`echo $j | grep executable_path`" == "" ]; then
			install_name_tool -change $j @executable_path/../Frameworks/$tmpVal $f
		fi
    done
    
    for libname in `otool -L $f | sed "1d" | grep @DCMTK_DIR@ | cut -d " " -f 1`
    do
    	baselibname=`basename $libname`
    	if [ ! -e Frameworks/DCMTK/$baselibname ]; then
			cp $libname Frameworks/DCMTK/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/DCMTK/$baselibname $f
	done
done

for f in Frameworks/DCMTK/*.dylib
do
	install_name_tool -id @executable_path/../$f $f

	for libname in `otool -L $f | sed "1d" | grep @DCMTK_DIR@ | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		if [ ! -e Frameworks/DCMTK/$baselibname ]; then
			cp $libname Frameworks/DCMTK/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/DCMTK/$baselibname $f
	done
done

for i in $( ls Frameworks | grep -E 'dylib' ); do
		#update library id
		install_name_tool -id @executable_path/../Frameworks/$i Frameworks/$i
		#update library links
		for j in $( otool -L Frameworks/$i | sed "1d" | grep -i -E '@medInria_DIR@|@dtk_DIR@|ttk|itk|vtk' | cut -d " " -f 1 ); do
			install_name_tool -change \
			$j @executable_path/../Frameworks/`echo $j | rev | cut -d "/" -f 1 | rev` \
			Frameworks/$i
		done
		
	for libname in `otool -L Frameworks/$i | sed "1d" | grep @DCMTK_DIR@ | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		install_name_tool -change $libname @executable_path/../Frameworks/DCMTK/$baselibname Frameworks/$i
	done

	#Qt stuff (should hopefully be there already)
	for j in $( otool -L Frameworks/$i | sed "1d" | grep -E .framework | grep -i -E 'Qt|phonon' | cut -d " " -f 1 ); do
		#Depending on Qt SDK, paths may be relative or not
		#tmpVal=`echo $j | rev | cut -d "/" -f 1-4 | rev`
		if [ "`echo $j | grep executable_path`" == "" ]; then
			install_name_tool -change $j @executable_path/../Frameworks/$j Frameworks/$i
		fi
    done
done; 

echo @CMAKE_INSTALL_PREFIX@/PackageRootDir
